# Nginx 面试题

## 什么是 Nginx

Nginx 是一个 **轻量级/高性能** 反向代理 Web 服务器，它可以实现高效的反向代理、负载平衡，处理 2-3 万并发连接数，官方监测能支持 5 万并发，现在中国使用 nginx 网站用户很多：新浪、网易、腾讯等。

## 为什么要用 Nginx？

跨平台、配置简单、反向代理、高并发连接（处理 2-3 万并发连接数）、内存小号小、处理静态文件好

Nginx 内置健康检查功能，如果有一个服务器宕机，会做一个健康检查，再发送的请求就不会发送到宕机的服务器了，重新将请求提交到其它节点上

使用 Nginx 还能：

1. 节省带宽：支持 gzip 压缩，可以添加浏览器本地缓存
2. 稳定性高：宕机的概率非常小
3. 接收用户请求是异步的

## Nginx是怎么处理请求的？

nginx 收到一个请求后，首先由 listen 和 server_name 指令匹配 server 模块，再匹配 server 模块里的 location，location 就是实际地址

```nginx
server {            		    	
	listen       80;      		  
	server_name  localhost;
	location / {      	
		root   html;       
		index  index.html index.htm;
	}          					
}      
```

## 什么是正向代理和反向代理？

- 正向代理：在客户端部署服务器，代替客户端对外部网络发送和接收消息（代理服务器在网络之前）
- 反向代理：在服务端部署代理服务器，让代理服务器替业务服务器请求或发送响应（代理服务器在网络之后）

使用反向代理的优点：

1. 占内存小，可实现高并发连接，处理响应快
2. 可实现 http 服务器、虚拟主机、方向代理、负载均衡
3. Nginx 配置简单
4. 可以不暴露正式服务器的 ip 地址

缺点：动态处理差，处理动态界面显得很鸡肋，现在一般前端用 nginx 反向代理抗住压力

## Nginx 应用场景

1. http 服务器：Nginx 是一个 http 服务，可以独立提供 http 服务，可以做网页静态服务器
2. 虚拟主机：可以实现一台服务器虚拟出多个网站，例如个人网站使用的虚拟机
3. 反向代理，负载均衡：当网站访问量达到一定程度后，单台服务器不能满足用户请求时，需要多台服务器集群可以使用 nginx 做反向代理。多台服务器可以平均分担负载，不会出现某台服务器负载高宕机而某台服务器闲置的情况
4. nginx 也可以配置安全管理，比如可以使用 Nginx 搭建 API 接口网关，对每个接口服务进行拦截

## location 的作用是什么

location 指令的作用是根据用户请求的 URL 来执行不同的应用，也就是根据用户请求的网站 URL 进行匹配，匹配成功则进行相关操作。`/` 是通用匹配符，任何请求都会匹配到。

## 限流是怎么做的

Nginx 限流就是限制用户的请求速度，防止服务器受不了，Nginx 限流是基于漏桶流算法，实现的三种限流算法：

1. 正常限制访问频率

   限制一个用户发送的请求，Nginx 多久接收一个请求。Nginx 中使用 `ngx_http_limit_req_module` 模块来限制访问频率，限制原理实质是基于漏桶算法原理来实现的。在 `nginx.conf` 配置中可以使用 `limit_req_zone` 命令及 `limit_req` 命令限制单个 IP 请求的处理频率。

2. 突发限制访问频率

   上面的配置一定程度可以限制访问频率，但也存在一个问题：如果突发流量超出请求被拒绝处理，无法处理活动时候的突发流量，这时应如何进一步处理呢？Nginx 提供 `burst` 参数结合 `nodelay` 参数可以解决流量突发的问题，可以设置能处理的超过设置的请求数之外能额外处理的请求数。

3. 限制并发连接数

   Nginx 中的 `ngx_http_limit_conn_module` 模块提供了限制并发连接数的功能，可以使用 `limit_conn_zone` 指令以及 `limit_conn` 进行配置

## 漏桶算法和令牌桶算法

漏桶算法是网络世界中**流量整形**或**速率限制**时的一种常用算法，主要目的是控制数据注入到网络的速率，平滑网络上的突发流量。突发流量可以被整形以便为网络提供一个稳定的流量。漏桶算法提供的机制：**突发流量会进入到一个漏桶，漏桶会按照我们定义的速率依次处理请求，如果突发流量过大则会直接溢出，多余的请求会被拒绝**，漏桶算法可以控制数据的传输速率。

令牌桶算法是网络世界中**流量整形**或**速率限制**时的一种最常使用的算法。令牌桶算法用于控制发送到网络上的数据的数目，并允许突发数据发送。令牌桶算法的实现机制：**存在一个固定大小的令牌桶，会以恒定的速率源源不断产生令牌。如果令牌消耗速度小于令牌产生的速度，令牌会一直产生直至装满整个桶**。

## 动静分离

Nginx 是当下最热的 Web 容器，网站优化重点在于静态化网站，网站静态化的关键点则是动静分离，动静分离是让动态网站里的动态网页根据一定规则把不变的资源和经常改变的资源区分开来，动静资源做好了拆分之后，则根据静态资源的特点将其做缓存操作。

让静态资源只走静态资源服务器，动态的走动态资源服务器

Nginx 的静态处理能力很强，动态处理能力不足

### Nginx 如何实现动静分离

只需要指定路径对应的目录。location 可以使用正则表达式匹配，并指定对应硬盘中的目录：

```nginx
location /image/ {
    root /usr/loacl/static;
    autoindex on;
}
```

创建目录：`mkdir /usr/local/static/image`

进入目录：`cd /usr/local/static/image`

放一张图片进去： `1.jpg`

重启 nginx：`sudo nginx -s reload`

打开浏览器输入：`server_name/image/1.jpg` 就可以访问该静态图片了

## Nginx 负载均衡是如何实现的？策略有哪些？

为了防止服务器崩溃，通常采用负载均衡来分担服务器压力。将对台服务器组成一个集群，当用户访问时，先访问到一个转发服务器，再由转发服务器将访问分发到压力更小的服务器。

Nginx 实现负载均衡的策略有以下五种：

1. **轮询（默认）**

   每个请求按照时间顺序逐一分配到不同的后端服务器，如果后端某个服务器宕机，则自动剔除故障系统：

   ```nginx
   upstream backserver {
       server 192.168.0.12;
       server 192.168.0.13;
   }
   ```
   
2. **权重 weight**

   如果后端服务器性能不均匀，通过设置不同的权值有效合理利用主机资源：

   ```nginx
   upstream backserver {
       server 192.168.0.12 weight=2;
       server 192.168.0.13 weight=8;
   }
   ```

   权重越高，被访问到的概率越大。

3. **Ip_hash（IP 绑定）**

   每个请求按访问 IP 的哈希结果分配，使来自同一个 IP 的访客固定访问一台后端服务器，并且可以有效解决动态网页存在的 sessions 共享问题

   ```nginx
   upstream backserver {
       ip_hash;
       server 192.168.0.12:88;
       server 192.168.0.13:88;
   }
   ```

4. **fair（第三方插件）**

   对比 weight、ip_hash 更加智能的负载均衡算法，fair 可以根据页面大小和加载时长更加智能进行负载均衡，响应时间短的优先分配：

   ```nginx
   upstream backserver {
       server server1;
       server server2;
       fair;
   }
   ```

   哪个服务器响应速度快，就将请求分配到那个服务器上。

5. **url_hash（第三方插件）**

   按访问 url 的 hash 结果来分配请求，使每个 url 定向到同一个后端服务器，可以进一步提高后端缓存服务器的效率：

   ```nginx
   upstream backserver {
       server squid1:3128;
       server squid2:3128;
       hash $request_url;
       hash_method crc32;
   }
   ```

## Nginx 高可用如何配置

当上游服务器一旦发生故障没有及时响应，应该直接轮询到下一台服务器，保证服务器的高可用。配置代码：

```nginx
server {
    listen		80;
    server_name	www.lijie.com;
    location / {
        ### 指定上游服务器负载均衡服务器
        proxy_pass http://backServer;
        ### nginx与上游服务器(真实访问的服务器)超时时间 后端服务器连接的超时时间_发起握手等候响应超时时间
        proxy_connect_timeout 1s;
        ### 发送给上游服务器(真实访问的服务器)超时时间
        proxy_send_timeout 1s;
        ### nginx接受上游服务器(真实访问的服务器)超时时间
        proxy_read_timeout 1s;
        index	index.html	index.htm;
    }
}
```

## Nginx 如何判断 IP 不可访问？

如果访问的 ip 地址为 192.168.9.115，则返回 403：

```nginx
if ($remote_addr = 192.168.9.115) {
	return 403;
}
```

## 如何限制浏览器访问

不允许谷歌浏览器访问，如果是谷歌浏览器则返回 500：

```nginx
if ($http_user_agent ~ Chrome) {
    return 500;
}
```

